name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  changes:
    name: Detect path changes
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.filter.outputs.app }}
      docs_mermaid: ${{ steps.filter.outputs.docs_mermaid }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'src/**'
              - 'public/index.html'
            docs_mermaid:
              - 'docs/**/*.md'
              - 'AGENTS.md'
              - 'README.md'
  node-quality:
    name: Lint / Format / Unit Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install deps
        run: npm ci || npm i --no-audit --no-fund
      - name: Normalize script permissions
        run: |
          chmod +x .husky/* 2>/dev/null || true
          chmod +x scripts/*.sh 2>/dev/null || true
      - name: ESLint
        run: npm run -s lint
      - name: Prettier (check)
        run: npm run -s format:check
      - name: Markdownlint
        run: npm run -s lint:md
      - name: Remark (links)
        run: npm run -s lint:md:links
      - name: Shell (syntax & optional shellcheck)
        env:
          FIX_EXEC: '1'
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          node scripts/check-shell.mjs $(git ls-files '*.sh' '.husky/*' | tr '\n' ' ')
      - name: Secretlint
        run: npx secretlint "**/*" --format stylish
      - name: Vitest
        run: npm run -s test

  e2e:
    name: E2E (conditional)
    runs-on: ubuntu-latest
    needs: [changes, node-quality]
    if: ${{ needs.changes.outputs.app == 'true' || needs.changes.outputs.docs_mermaid == 'true' || github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install deps
        run: npm ci || npm i --no-audit --no-fund
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Mermaid syntax check
        run: npm run -s lint:mermaid
      - name: Run e2e (placeholder)
        run: npm run -s test:ui

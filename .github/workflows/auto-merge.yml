name: Auto Merge
on:
  pull_request:
    types: [labeled, synchronize, ready_for_review]
permissions:
  contents: write
  pull-requests: write
jobs:
  enable-auto-merge:
    if: contains(join(github.event.pull_request.labels.*.name, ','), 'automerge')
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge via GraphQL
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr?.number) {
              core.setFailed('No pull_request context/number');
              return;
            }
            const { data } = await github.rest.pulls.get({ ...context.repo, pull_number: pr.number });
            const node_id = data.node_id;
            const method = 'SQUASH';
            try {
              // NOTE: 'method' is a reserved option key for @octokit/graphql; avoid using it as a var name
              await github.graphql(
                `mutation($id:ID!,$m:PullRequestMergeMethod!){ enablePullRequestAutoMerge(input:{pullRequestId:$id, mergeMethod:$m}){ clientMutationId } }`,
                { id: node_id, m: method }
              );
              await github.rest.issues.createComment({ ...context.repo, issue_number: pr.number, body: `Auto-merge enabled (method: ${method}).` });
            } catch (e) {
              // Post a helpful message rather than failing hard
              const msg = `Auto-merge could not be enabled yet. Conditions: required checks passing, not draft, branch up-to-date.\n\nError: ${e?.message || e}`;
              await github.rest.issues.createComment({ ...context.repo, issue_number: pr.number, body: msg });
            }

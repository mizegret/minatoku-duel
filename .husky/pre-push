#!/usr/bin/env sh

echo "[pre-push] Rebase guard + Guard PR size/issue & Lint/Format/Test/Docs..."

# Rebase guard: ensure branch is up-to-date with base before push
"$(git rev-parse --show-toplevel)/scripts/hooks/pre-push-rebase-guard.sh" || exit 1

# Early PR guard (large diff / missing issue in branch name)
node scripts/guard-pr.mjs || exit 1
npm run -s lint || exit 1
npm run -s format:check || exit 1
npm test || exit 1
npm run -s lint:md || exit 1
npm run -s lint:md:links || exit 1

# Mermaid の厳密チェックはCIで必須。ローカルではエラー時のみ通知。
npm run -s lint:mermaid || echo "[pre-push] Mermaid 構文検証はCIで実施（ローカルは任意）"

# シークレットスキャン（軽量）
npx --no-install secretlint "**/*" --format stylish || exit 1

# アセット健全性（サイズ/有無）
npm run -s lint:assets || exit 1

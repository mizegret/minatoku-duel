# Model + Rules Evolution Plan (MVP → Phase 1)

本ドキュメントは「カード/スコア/UI」を段階的に進化させるための作業計画です。
各タスクは“挙動不変（または影響極小）”で進め、最終段で切り替えを行います。
完了後に本ファイルは削除予定。

## 背景 / 目的
- 仕様拡張（例: 人間の年齢・基礎魅力・専用スキル・フレーバー等）に耐えるデータ/ロジック基盤を作る。
- スコアリングを「人/装飾/行動」に正しく紐付けられる設計へ漸進的に移行する。
- 将来的なUIレンダラ（Canvas/WebGL 等）切替の前段として、モデル/集計/ルールを安定化する。

---

## ビジョン（現時点のイメージ共有）
- 画面は「飲み会テーブル」。オジ席が中央にあり、召喚した港区女子が横へ着席していく。
- 装飾は基本的にオジからのプレゼント（化粧直しで装備変更する演出を将来追加）。
- 勝敗は最終ターン後、場にいる女子のうち魅力が最大の1人をオジが選び、その陣営が勝利（同点時の裁定は現行ルール踏襲）。
- 複数体の女子は“ヘルパー”として支援役も想定（スキル/装飾/座席での補助）。

---

## 進め方（ルール）
- 1タスクずつPR粒度で実施。各タスクは受け入れ条件を満たすこと。
- “切り替えフラグ”の導入で、段階1〜3は挙動不変を維持しつつ備える。
- すべてのタスクはブラウザのみで成立（Node導入は別スコープで検討）。

---

## タスク一覧（チェックリスト）

- [ ] [M0] カードスキーマの検討/設計（ドラフト）
  - 目的: 今後の拡張（人間の年齢/基礎魅力/専用スキル/フレーバー等）を過不足なく表現できるスキーマを定義。
  - 成果物: `docs/cards-schema.md`（JSON構造のドラフト／必須・任意項目／型／制約）、`public/cards.example.json`（サンプル）
  - 項目案:
    - 共通: `id:string`, `name:string`, `type:'human'|'decoration'|'action'`, `rarity?:string`, `tags?:string[]`, `flavor?:string|string[]`
    - human: `age?:number`, `baseCharm?:number`, `baseOji?:number`, `skills?: Skill[]`
    - decoration: `charm?:number`, `oji?:number`, `slotsUsed?:number`
    - action: `effect?: Effect[]`（既存の `op/stat/target/value` 構造を明確化）
  - 受け入れ: 既存cards.jsonを包含（後方互換）。不足項目は検討課題としてTODO列挙。Node導入なしで運用可能な範囲に留める。
  - 影響: ドキュメントのみ（実装変更はM1以降）。

- [ ] [M1] カードスキーマの先取り拡張（人間）
  - 目的: 今後の要件（年齢/基礎魅力/スキル/フレーバー）を受け止められる器を用意。
  - 変更: `loadCards()` で human の拡張キーをそのまま保持（UI/スコアでは未使用）。
  - 項目案（全部任意）: `age:number`, `baseCharm:number`, `skills: string[]`, `flavor:string | string[]`。
  - 受け入れ: ロードログ/送受信/stateに破壊的変化なし。従来のcards.jsonでも動作。
  - 影響: `public/app.js:loadCards`

- [ ] [M2] 場の人間に基礎魅力を保持（保存のみ）
  - 目的: 召喚時に human 情報を場へ正しく投影できるように。
  - 変更: host側 `summon` で `field.humans.push({ id, name, baseCharm, decorations: [] })` に拡張。
  - 受け入れ: スコア加算は従来どおり（+1固定）。表示・ログは不変。
  - 影響: `public/js/game/host.js`

- [ ] [M3] スコア集計器の追加（裏取りのみ）
  - 目的: 「人/装飾/行動」から合計スコアを純関数で算出できる基盤作成。
  - 変更: `computeScoresFromField(field)` を新設（`utils/score.js`）。今は集計結果をログに出すだけ（差し替えはまだしない）。
  - 受け入れ: Host配信スコアと集計器の結果が一致することをログで確認（不一致はwarn）。
  - 影響: `public/js/utils/score.js`（新規）, `public/js/game/host.js`（呼び出し）

- [ ] [M4] スコアルール外出し
  - 目的: どのタイミングで何点加算/減算するかを表形式にして切替可能に。
  - 変更: `public/js/constants.js` に `SCORE_RULES` を追加（例: summon: +baseCharm or +1, decorate: +card.charm, play: effects）。
  - 受け入れ: 現状ルールと同一の結果になるデフォルトテーブルを用意。将来はここを入れ替えるだけで挙動変更可能に。
  - 影響: `constants.js`, `host.js`（適用時）

- [ ] [M5] カードデータのライトバリデーション
  - 目的: 早期にデータ不整合を検知。
  - 変更: `loadCards()` に必須キー/型チェック（不足は警告＋妥当なデフォルト補完）。
  - 受け入れ: 既存cards.jsonは通過。誤データ時はconsole.warnのみ（動作は継続）。
  - 影響: `public/app.js:loadCards`

- [ ] [M6] ランダムseedの保存（任意）
  - 目的: リプレイ/検証しやすくするため、配布時にseedをstateへ保存。
  - 変更: `ensureStarted()` で `state.hostGame.seed` を保持（将来shuffle再現に使用）。
  - 受け入れ: 現挙動不変（seed未使用）。
  - 影響: `public/js/game/host.js`

- [ ] [SWITCH] スコア計算の切替（仕様変更タイミング）
  - 条件: M1〜M4が安定し、集計器の結果が十分に信用できること。
  - 変更: `summon/decorate/play` の加点を「場/カード起点の計算へ」切替。
  - 受け入れ: ルールの新仕様に基づくスコア・ログが期待通りになること。

---

## 作業順序（推奨）
1. [M1] → 2. [M2] → 3. [M3] → 4. [M4] → 5. [M5] → 6. [M6] → 7. [SWITCH]

---

## ロールバック方針
- 各タスクは小粒で独立。問題発生時は該当コミットをrevertして復旧。
- SWITCH前は挙動不変のため、UI/通信への影響は限定的。

---

## メモ
- UIレンダラ選定（Pixi/React等）は SWITCH 直前/直後に別トラックで実施予定。
- Node導入（Vite/Vitest等）は別計画。純関数のテスト需要が高まった段階で再検討。

---

## オープンクエスチョン（確認事項）
1. 勝敗の同点裁定は「場の人間数が多い方 → 先攻側敗北（現行踏襲）」で良いか？
2. 座席数（同時に着席できる人数の上限）は当面3で良いか？（将来可変）
3. humanの拡張項目（age/baseCharm/baseOji/skills/flavor）の初期値運用（未指定時は無効/0/空配列）でOKか？
4. オジの嗜好（preferences）は先取りで器だけ持ち、当面ニュートラル（補正0）で良いか？
5. scoreRulesの初期テーブルは「現行結果と一致（=baseCharmを未使用扱い）」で開始してOKか？

---

## 決定事項（2025-10-05）
- 勝敗の同点裁定: 引き分けとする。
- 座席数（上限）: 当面は3席（定数 `MAX_SEATS = 3` として扱い、将来可変）。
- オジ preferences: いまは導入しない（器の先取りも保留）。
- SCORE_RULES: 導入する（A）。初期設定は現行の結果と完全一致（= baseCharm は当面未使用）。実装タイミングは M4 で行うが、M3 完了後できるだけ早めに適用。

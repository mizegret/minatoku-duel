# 港区Duel（Minato Duel）仕様ドラフト v0.1

## 1. コンセプト / 目標体験
- テーマ: 港区カルチャーをモチーフにした軽量リアルタイムカードデュエル。
- 体験: プレイヤーは港区女子（人間系）を召喚し、装飾系で盛り、アクション系で駆け引き。魅力ポイントとオジ好感度を稼いで勝負。最終目標は「玉の輿（=高得点）」の勝利演出。
- トーン: ユーモラスかつメタ視点。ただしゲーム体験としては堅実なカードデュエル。

## 2. デバイス / ブラウザ
- 優先順位: スマホ ≧ PC > タブレット。
- スマホ縦画面最適化を念頭にしつつ、PCでも遊べるようレイアウト調整。
- 対応ブラウザ: 最新版 Chrome / Safari / Edge（モダン環境前提）。

## 3. プレイ規模・時間
- MVP 同時接続: 2 人（将来的には 2〜4 人拡張余地）。
- 1 プレイ時間: 10〜15 分想定。
- デッキ構成（MVP固定）: 各人 20 枚（手札 5 + 山札 15）。
  - カード内訳: 人間 5 / 装飾 10 / アクション 5。
  - 初手 5 枚、ターン毎に 1 枚ドロー（山札枯渇時はドローなし）。

## 4. URL / 導線（MVP）
- ポータル: `https://games.mizegret.com`。
- ルーム: `/room/<roomId>`（初期ゲーム = 港区Duel）。
- トップページから「新しい部屋を作る」ボタンで ID 生成 → `/room/<id>` に遷移。
- ルーム画面に「招待リンクをコピー」ボタンを配置。
- 将来: 複数ゲーム対応時には `/ <gameId> /room/<roomId>` 形式を併用可能。

## 5. ゲームルール（MVP）
### 5.1 カード種別
- 人間系: 港区女子（例: minami / rina）— 場に召喚。
- 装飾系: バッグ / シャンパンなど — 人間 1 体に装備（1 体につき上限 2）。
- アクション系: 即時効果（例: トイレで陰口=相手装飾一時無効, インスタ自慢=一時的魅力ブースト）。
- 最小プロパティ: `id`, `name`, `type`, `charm`（+x）, `ojisan`（+y）, `text`（説明文）。

### 5.2 セットアップ
- 先攻後攻はランダム決定。
- 各自デッキを配布（乱数 seed による再現性は後回し可）。
- 初手 5 枚、ターン開始時に 1 ドロー（山札枯渇時はドローなし）。

### 5.3 ターン進行
1. ドロー（任意）
2. アクション 1 回のみ選択:
   - 召喚（人間） *場の人間枠は 2 体まで*
   - 装飾（人間 1 体へ装備、各 1 体上限 2）
   - アクション（即時効果）
3. 当ターンの魅力 / 好感度増分を合計へ反映。
4. ターンエンド → 相手へ。

### 5.4 勝敗
- 両者 5 ターン終了後（各自 5 手）の合計スコア（魅力 + オジ好感度）が高い方が勝利。
- 同点時は場の人間数が多い方、それも同数なら先攻側が敗北。

## 6. 画面と必須要素（MVP）
### 6.1 トップ `/`
- タイトル「港区Duel」。
- 「新しい部屋を作る」ボタン（ID 生成 → `/room/<id>` 遷移）。
- ヘルプ: Room ID は `a–z`, `0–9`, `-` の 4〜32 文字／URL を共有して参加。

### 6.2 ルーム `/room/<id>`
- `Room: <id>` 表示 + 招待リンクコピー機能。
- 自分の手札表示（枚数がわかる程度、仮 UI 可）。
- 自分の場: 人間枠 2 × 装飾枠 2。
- 相手情報: 人間数 / 装飾数 / 公開済み効果。
- スコア: 魅力 / 好感度 / 合計。
- 行動ボタン: 召喚 / 装飾 / アクション / スキップ（1 手制限）
- 可視化: MVP ではリアルタイム同期のみに集中（履歴・チャットは後回し）。

## 7. スコア計算・判定
- 人間: 召喚時 `charm:+1`（例）。
- 装飾: 装備中ターンごと `ojisan:+1`（例）。
- アクション: 一時効果（例: 相手装飾無効化, `charm:+2`など）。
- 勝敗: 上記スコア合計のみ厳密に実装。複雑効果は後回し。

## 8. 同期方式 / 通信
- 使用サービス: **Ably (Pub/Sub のみ)**。
- チャンネル: `room:<roomId>`。
- イベント種別: `join` / `start` / `move` / `state`（ホスト権威で state を確定配布）。
- 入室ハンドシェイク: `probe` → 応答があれば `busy`、応答無の場合は自分が `hello (host)` として振る舞う。
- キー運用: 現状は弱い権限キー（capabilities: publish/subscribe, scope: `room:*`）。将来的に Cloudflare Worker を用いた Token Auth へ切替予定。

## 9. 技術方針 / 制約
- フロントのみ（静的サイト）: Cloudflare Pages を使用し、`_redirects` でルーティング制御。
- 禁止技術: なし（MVP 最小）。LocalStorage / ServiceWorker は必要になった時点で導入検討。
- 外部ライブラリ: 可能な限り少なく。CSS は素の CSS または最小のユーティリティ。
- アニメーション: 将来強化を予定、MVP では控えめ。
- アセット: 当面はプレースホルダや軽量素材。画像・音声は後日導入。
- 依存 API: 現状 Ably のみ。
- ホスティング: Cloudflare Pages（ドメイン: `games.mizegret.com`、Route53 CNAME 連携）。

## 10. MVP の線引き
### Must
- ルーム作成 → URL 共有 → 2 人プレイ開始。
- デッキ配布（乱数で 10〜15 枚）と手札表示。
- 召喚 / 装飾 / アクション各 1 回/ターンの制御。
- スコア加算と勝敗判定の表示。
- Ably を用いたリアルタイム同期。

### Nice to have
- アバター演出（カードのビジュアル）。
- チャット / 履歴ログ / 観戦モード。
- スマホ向けアニメーションや効果音。
- デッキビルド機能やランクマッチ。

## 11. 進め方 / マイルストーン
- **M0: 土台** — `/` と `/room/<id>` のルーティング、招待リンクコピー、Ably 接続と `join/start/move/state` の骨組み。
- **M1: 対局成立** — デッキ配布、ターン制と 1 手制限、魅力/好感度ロジックと勝敗表示。
- **M2: 見た目** — スマホ優先 UI 調整、最小アニメーション、占位用アセット。
- **M3: 磨き** — 満室・離脱ハンドリング、再接続、アクション効果拡張、カード追加。
- 期限: 固定なし。各マイルストーン到達で小リリース。PR ごとに Cloudflare Pages Preview で確認。

## 12. 準備物（コーディング前に最小）
- ワイヤーフレーム（トップ / ルーム / 手番 UI の 3 画面）。
- カード定義の雛形（各 10〜15 枚、JSON 最小構成）。
- テスト計画（軽量）:
  - 2 タブで手番・スコア同期がとれる。
  - 勝敗判定が想定どおり。
  - 満室時の挙動（受付拒否 / 案内）。

## 13. 後で Issue 化予定（優先度: 高 → 低）
1. Ably Token Auth（Cloudflare Worker 導入）。
2. 断線・再接続、ホスト移譲ロジック。
3. スマホ UI 最適化（幅・入力・タップ領域）。
4. アバター / エフェクト設計（軽量アセット指針）。
5. 複数ゲーム対応 URL 設計（`/<gameId>/room/<id>`）。
6. 観戦モード・履歴ログ機能。
7. デッキバランス調整フレーム。

## 付録: 未決事項（要検討）
- MP（コスト）のリソース名と消費 / 回復仕様（港区モチーフへのフィット）。
- カードデータの最小定義フォーマット（JSON 項目、効果種別）。
- 演出基調: カラーパレット（候補: 沖縄の海トーン）、フォント、アイコン指針。

## 14. 技術メモ（MVP向け環境変数管理）
- ローカル開発: `public/env.local.json` を用意し、同形式でキーを保持。`public/env.local.json.example` をテンプレとして配布。
- 秘匿性は低いため、将来的に Cloudflare Worker 等で Ably Token Auth を導入し、ブラウザ配布を避ける。
- 追加予定の Issue: 「Ably Token Auth 実装（Worker導入）」で追跡。
- Cloudflare Pages 本番/Preview: `functions/env.js`（Pages Functions）経由で `/env` を返し、環境変数をブラウザへ渡す。
- UI強化メモ: 人間カードと装飾カードのレイヤー表示（人物カードに装飾を重ねるUI）、アバター表現の検討はスタイル整備の次フェーズで対応。

## 15. リアルタイムメッセージ仕様（Ably）
- 共通フォーマット: `channel.publish(<event>, <payload>)` の形で送受信。payload は JSON オブジェクトで揃える。

- `join`
  - 送信者: 参加したクライアント（自動送信）。
  - 受信者: 全員（ホストは参加者リストを更新し、他クライアントは参加者表示を更新）。
  - payload: `{ clientId, joinedAt }`
  - 備考: 当面は `clientId` の簡易表示で運用し、名前入力は将来の Issue とする。ホストは受信後に参加者リストを更新し、最新の `state` をブロードキャストする。

- `start`
  - 送信者: ホスト。
  - 受信者: 全員（参加者はゲーム開始を把握し、ローカル状態を初期化）。
  - payload: `{ roomId, hostId, members: [{ clientId }], startedAt }`
  - 備考: start 時点でホストが権威となり、以降はホストのみ `state` を送る。

- `move`
  - 送信者: 各プレイヤー（1ターンにつき1回）。
  - 受信者: 全員（ただしホストのみ処理し、他端末はログ用程度に留める）。
  - payload: `{ clientId, round, action: 'summon' | 'decorate' | 'play' | 'skip', cardId?, targetId?, extras? }`
  - 備考: ホストのみが処理し、正当性チェック後に `state` 更新。クライアント側は UI を更新せず `state` を待つ。

- `state`
  - 送信者: ホスト。
  - 受信者: 全員（ホストの authoritative state を同期）。
  - payload 例:
    ```json
    {
      "phase": "in-round",
      "round": 3,
      "turnOwner": "client-123",
      "players": [
        { "clientId": "client-123", "hand": ["c01", "c02"], "field": {...}, "scores": { "charm": 4, "oji": 5 } },
        { "clientId": "client-456", ... }
      ],
      "log": [ { "type": "move", "clientId": "client-123", "message": "召喚 → c05", "at": 1728000000 } ],
      "updatedAt": 1728000000
    }
    ```
  - 備考: クライアントは `state` をそのまま描画状態に反映し、ローカル表示をリセットする。

- 公開メモ: README にキー設定とイベント仕様の概要を追記予定。将来的にサーバ側検証へ移行できるよう、payload は冗長でも明示的に定義する。

## 16. 現行実装サマリ（MVP, 2025-10-05）

- スタート/参加
  - Host = ルーム作成者。2 人揃ったら自動開始。
  - デッキ配布（各人 20 枚: 人間5 / 装飾10 / ムーブ5）。手札 5、山札 15。プレイヤーごとにシャッフル。

- ターン/ラウンド進行
  - 1 ラウンド = 双方 1 手ずつの合計 2 手（half=0/1）。
  - 自分の手番が来たときにラウンド数を“見る”仕様。双方が動いたら次ラウンドへ。
  - 手番開始時に 1 ドロー（最終ラウンド終了は除く）。
  - スキップは「このターンは様子見」ボタンで送信（`action: 'skip'`）。

- 行動の種類（手札クリック運用）
  - 召喚（human）: 自分の場に人間を 1 体追加。charm +1。
  - 装飾（decoration）: 空き枠のある最初の人に装備（1 体につき最大 2）。装備時にカード定義の charm を加算（デフォルト +1）。好感度（oji）は上げない。付与先/装飾が無い場合は送信しない（手番維持）。
  - ムーブ（action/move）: 所作カード。現状は self.oji を +1 する効果で統一。場に人間がいない場合は送信しない（手番維持）。

- UI 表示・秘匿
  - 相手の手札は秘匿（カード名は出さず“？？？”）。
  - 自分のターン以外/ロック中は自分の手札を半透明＆クリック不可。

- ログ
  - `lastAction` を `state` に含め、クライアントで「あなた/相手：召喚/装飾/ムーブ → 名称（魅力+X / 好感度+Y）」形式で表示。

## 17. カードデータ（cards.json）スキーマ（MVP）

```jsonc
{
  "cards": [
    { "id": "human-001", "type": "human", "name": "南青山 みなみ" },
    { "id": "deco-001",  "type": "decoration", "name": "ヴィトンバッグ", "charm": 2 },
    { "id": "act-010",   "type": "action",    "name": "テーブル下の足タッチ",
      "effect": [ { "target": "self", "stat": "oji", "op": "add", "value": 1 } ] }
  ]
}
```

- 必須: `id`, `type`（human|decoration|action）, `name`。
- 装飾: `charm`（数値, optional, 省略時 +1）。`oji` は今は未使用（装飾では上げない）。
- ムーブ: `effect` 配列。各要素は `{ target: 'self'|'opponent', stat: 'charm'|'oji', op: 'add', value: 数値 }`。

## 18. サーバ/クライアント ガード

- クライアント
  - ムーブは場に人間がいないと送らない（alert のみ）。
  - 装飾は付与先がいない/枠が無いと送らない（alert のみ）。

- サーバ（ホスト）
  - 召喚/装飾/ムーブは Host が手札から ID 照合して適用（権威）。
  - 不正 payload は無視。将来的に「不成立＝手番維持」の no-op state を返す方針（現状はクライアント側ガードで到達しない想定）。
